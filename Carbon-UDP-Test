 - name: grower_opportunity_detail
    description: Opportunity level view of up to date closed won carbon opportunities, qualifiers, and contracts. This is the master view of carbon opportunities and accounts.
    columns:
      opportunity_id:
        type: string
        description: Opportunity ID from SFDC.
      opportunity_name:
        type: string
        description: Opportunity name from SFDC.
      account_id:
        type: string
        description: SFDC account associated with the opportunity
      opportunity_date:
        type: timestamp_tz
        description: Opportunity closed won date
      opportunity_type:
        type: string
        description: Type of SFDC opportunity - Carbon or Indigo acres
      contract_status:
        type: string
        description: SFDC status of contract
      activated_date:
        type: timestamp_tz
        description: Date the contract was activated
      contract_acres:
        type: float
        description: The total number of acres on the contract.
      contract_number:
        type: float
        description: Contract number
      contracts:
        type: array
        description: Array of carbon and IA contract numbers associated with that account ID.
      is_your_land_crop_land_or_pasture_land:
        type: string
        description: Response to cropland and pastureland qualifier question in SFDC.
      cc_cleared_within_10_years:
        type: string
        description: Response to land clearing qualifier question in SFDC.
      carbon_sequestration_compensation:
        type: string
        description: Response to existing carbon sequestration qualifier question in SFDC.
      qualifier_is_eligible_according_to_sfdc:
        type: boolean
        description: Boolean indicating if qualifier makes opportunity eligible in SFDC.
      eligibility_cleared_land:
        type: string
        description: IFW response to land clearing qualifier.
      eligibility_sequestration_program:
        type: string
        description: IFW response to carbon compensation qualifier.
      opp_is_eligible_according_to_ifw:
        type: boolean
        description: Boolean indicating if qualifier makes opportunity eligible in IFW.
      opportunity_is_eligible:
        type: boolean
        description: Boolean if SFDC opportunity has eligible qualifier and closed won opportunity.
      is_eligible_for_carbon:
        type: boolean
        description: Final statement on whether opportunity and contract is eligible for carbon.
      eligibility_source:
        type: string
        description:
    source: |
      with QUALIFIER as (
        select * 
          from SFDC_QUALIFIER
          where rank = 1
      )
      select o.opportunity_id
        , o.opportunity_name
        , o.account_id
        , o.close_date
        , o.opportunity_type
        , c.contract_status
        , c.activated_date
        , c.total_acres as contract_acres
        , c.contract_number
        , c.contracts
        , q.is_your_land_crop_land_or_pasture_land
        , q.cc_cleared_within_10_years
        , q.carbon_sequestration_compensation
        , q.qualifier_is_eligible_according_to_sfdc
        , i.eligibility_cleared_land
        , i.eligibility_sequestration_program
        , i.opp_is_eligible_according_to_ifw
        , case when o.stage_name = 'Closed Won' and q.qualifier_is_eligible_according_to_sfdc = True then True else False end as opportunity_is_eligible
        , case when c.contract_number is not null and (opportunity_is_eligible or opp_is_eligible_according_to_ifw) then True else False end as is_eligible_for_carbon
        , case 
            when ifnull(qualifier_is_eligible_according_to_sfdc, False) AND ifnull(opp_is_eligible_according_to_ifw, False) then 'Both'
            when ifnull(qualifier_is_eligible_according_to_sfdc, False) and NOT ifnull(opp_is_eligible_according_to_ifw, False) then 'SFDC Only'
            when ifnull(opp_is_eligible_according_to_ifw, False) and NOT ifnull(qualifier_is_eligible_according_to_sfdc, False) then 'IFW Only'  
          end as eligibility_source
        from OPPORTUNITY o
        left join CONTRACT c
        on o.opportunity_id = c.opportunity_id
        left join QUALIFIER q
        on o.opportunity_id = q.opportunity_id
        left join IFW_CARBON_QUALIFIER i
        on o.account_id = i.account_id
        where o.stage_name = 'Closed Won';

###########################################################################################################################################
select a.id as account_id
    , a.email as salesforce_email
--    , a.____ as duplicate_email_flag
    , b.assigned_commercial_region_c as region
    , c.activated_date as carbon_contract_dt
    , case when e.stage_name = 'Closed Won' then True else False end as is_acres_grower
    , f.effective_dt as IFW_enrollment_dt
    , g.state_eligible_for_carbon as eligible_state
    , h.opportunity_is_eligible as SF_carbon_opp_status
    , j.user_id as IFW_email
    , case when (k.mp_supply_profile_count + k.mp_demand_profile_count > 0) then True else False end as MP_involvement 
    , sum(c.total_acres) as SF_contract_acres
    , sum(d.acreage) as carbon_tagged_acres
    , sum(case when d.is_carbon = True then d.acreage else 0 end) as carbon_enrolled_acres    
    from parthenon.accounts.legal_entity a
    left join parthenon.salesforce_v2.user b
        on a.id = b.account_id 
    left join parthenon.carbon.contract c
        on a.id = c.legal_entity_id
    left join parthenon.carbon.field d
        on a.id = d.account_id
    left join parthenon.carbon.indigo_acres_opportunity e
        on a.id = e.account_id
    left join parthenon.carbon.agreements f
        on a.id = f.account_id
    left join parthenon.carbon.states g
        on d.state = g.state
    left join parthenon.carbon.grower_opportunity_detail h
        on a.id = h.account_id
    left join parthenon.dca_db.dca_growers i
        on a.id = i.external_id
    left join parthenon.dca_db.dca_user_profiles j
        on i.id = j.id
    left join parthenon.accounts.salesforce_account_summary k
        on a.id = k.salesforce_account_id
    group by 1,2,3,4,5,6,7,8,9,10
    limit 50
        
